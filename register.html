<!DOCTYPE html>
<html>
<head>
    <title>ƒêƒÉng k√Ω s·ª≠ d·ª•ng Firmware</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <meta name="color-scheme" content="dark light">
    <meta name="description" content="ƒêƒÉng k√Ω s·ª≠ d·ª•ng firmware OneHUD">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="container">
        <main class="main-content">
            <div class="flash-section">
                <div class="flash-card">
                    <div class="device-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h2>ƒêƒÉng k√Ω s·ª≠ d·ª•ng Firmware</h2>
                    <p>ƒêƒÉng k√Ω ƒë·ªÉ nh·∫≠n quy·ªÅn truy c·∫≠p v√† s·ª≠ d·ª•ng firmware ch√≠nh th·ª©c</p>
                    
                    <div class="register-container">
                        <div class="register-form">
                            <div class="form-group">
                                <label for="email">
                                    <i class="fas fa-envelope"></i> Email nh·∫≠n th√¥ng tin
                                </label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    placeholder="name@example.com" 
                                    required
                                    class="form-input"
                                >
                            </div>
                            
                            <div class="form-note">
                                <p>üí° Sau khi thanh to√°n th√†nh c√¥ng qua QR code b√™n ph·∫£i, vui l√≤ng nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ th√¥ng b√°o</p>
                            </div>
                            
                            <div class="button-row">
                                <button id="registerBtn" class="btn btn-primary btn-large">
                                    <i class="fas fa-check-circle btn-icon"></i>
                                    Th√¥ng b√°o ƒë√£ chuy·ªÉn ti·ªÅn
                                </button>
                            </div>
                            
                            <div id="statusMessage" class="status-message"></div>
                        </div>
                        
                        <div class="payment-section">
                            <h3><i class="fas fa-credit-card"></i> Thanh to√°n</h3>
                            <p class="payment-info">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n ph√≠ ƒëƒÉng k√Ω</p>
                            <div class="qrcode-container">
                                <img src="qrcode.jpg" alt="QR Code Thanh To√°n" class="qrcode-image">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <section class="instructions">
                <h2><i class="fas fa-list-ol"></i> H∆∞·ªõng d·∫´n ƒëƒÉng k√Ω</h2>
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Nh·∫≠p email</h3>
                            <p>ƒêi·ªÅn ƒë·ªãa ch·ªâ email ƒë·ªÉ nh·∫≠n link firmware v√† th√¥ng tin c·∫≠p nh·∫≠t</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Thanh to√°n</h3>
                            <p>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n ph√≠ ƒëƒÉng k√Ω s·ª≠ d·ª•ng firmware</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Th√¥ng b√°o ƒë√£ chuy·ªÉn ti·ªÅn</h3>
                            <p>Sau khi thanh to√°n th√†nh c√¥ng, nh·∫•n "Th√¥ng b√°o ƒë√£ chuy·ªÉn ti·ªÅn". Ch√∫ng t√¥i s·∫Ω ki·ªÉm tra v√† g·ª≠i link firmware cho b·∫°n qua email</p>
                        </div>
                    </div>
                </div>
            </section>
            
        </main>
        
        <footer>
            <p>&copy; <span id="currentYear"></span> OneHUD Team</p>
            <p class="build-info">Version: <span id="appVersion">2.0.2</span></p>
        </footer>
    </div>
    
    <!-- SCRIPTS -->
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
    <script type="module">
    // DOM Ready
    const registerBtn = document.getElementById("registerBtn");
    const emailInput = document.getElementById("email");
    const statusMessage = document.getElementById("statusMessage");
    const currentYearElement = document.getElementById('currentYear');
    if (currentYearElement) currentYearElement.textContent = new Date().getFullYear();

    function showStatus(msg, type = 'info') {
      statusMessage.textContent = msg;
      statusMessage.className = 'status-message status-' + type;
      statusMessage.style.display = 'block';
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    async function getDeviceMac() {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        const ESPLoader = window["esp-web-tools"].ESPLoader;
        const loader = new ESPLoader(port, { log: ()=>{} });
        await loader.main_fn();
        const mac = await loader.macAddr();
        await loader.disconnect();
        await port.close();
        return mac;
      } catch (e) {
        throw new Error('Kh√¥ng th·ªÉ nh·∫≠n di·ªán thi·∫øt b·ªã!');
      }
    }

    async function sendTelegram(email, mac) {
      const botToken = '8464026703:AAFd_w4fL09HFaZ3s_LI81tLJJhyvt0whWs';
      const chatId = '7158639072';
      const message = `üÜï ƒêƒÉng k√Ω m·ªõi!\n\nüìß Email: ${email}\nüîê MAC: ${mac}\n‚è∞ Th·ªùi gian: ${new Date().toLocaleString('vi-VN')}`;
      const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId, text: message, parse_mode: 'HTML' })
      });
      if (!response.ok) throw new Error('Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu!');
    }

    registerBtn.addEventListener('click', async function () {
      const email = emailInput.value.trim();
      if (!validateEmail(email)) {
        showStatus('‚ùå Vui l√≤ng nh·∫≠p email h·ª£p l·ªá!', 'error');
        return;
      }
      registerBtn.disabled = true;
      try {
        const mac = await getDeviceMac();
        await sendTelegram(email, mac);
        showStatus('‚úÖ Th√¥ng b√°o ƒë√£ g·ª≠i. Ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi qua email sau khi x√°c nh·∫≠n.', 'success');
        emailInput.disabled = true;
      } catch (e) {
        showStatus('‚ùå C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.', 'error');
        registerBtn.disabled = false;
      }
    });
    </script>
    <script src="assets/js/register.js"></script>
</body>
</html>

